name: Update arXiv Papers Dashboard

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes (for testing)
  workflow_dispatch:  # Allow manual triggers

jobs:
  update-papers:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Fetch and update papers
        id: update_papers
        run: |
          cat > update_papers.js << 'NODEJS_EOF'
          const https = require("https");
          const fs = require("fs");
          
          function fetchPapers() {
            return new Promise((resolve, reject) => {
              const searchQuery = encodeURIComponent("cat:cs.AI AND submittedDate:[2026-02-10 TO 2026-02-17]");
              const url = "https://export.arxiv.org/api/query?search_query=" + searchQuery + "&max_results=10&sortBy=submittedDate&sortOrder=descending";
              
              console.log("Fetching papers from arXiv API...");
              
              https.get(url, (res) => {
                let data = "";
                res.on("data", chunk => data += chunk);
                res.on("end", () => {
                  try {
                    const papers = parseXMLPapers(data);
                    resolve(papers);
                  } catch (e) {
                    reject(e);
                  }
                });
              }).on("error", reject);
            });
          }
          
          function parseXMLPapers(xmlData) {
            const papers = [];
            const entryRegex = /<entry>([\s\S]*?)<\/entry>/g;
            let match;
            
            while ((match = entryRegex.exec(xmlData)) !== null) {
              const entry = match[1];
              const paper = {};
              
              const titleMatch = entry.match(/<title>([\s\S]*?)<\/title>/);
              paper.title = titleMatch ? titleMatch[1].trim() : "Unknown";
              
              const idMatch = entry.match(/<id>.*?\/abs\/([^<]+)<\/id>/);
              paper.id = idMatch ? idMatch[1] : "";
              
              const authorMatches = entry.match(/<author>[\s\S]*?<name>(.*?)<\/name>[\s\S]*?<\/author>/g) || [];
              paper.authors = authorMatches.map(a => {
                const nameMatch = a.match(/<name>(.*?)<\/name>/);
                return nameMatch ? nameMatch[1] : "";
              });
              
              const pubMatch = entry.match(/<published>([\d-]+)/);
              paper.published = pubMatch ? pubMatch[1] : new Date().toISOString().split("T")[0];
              
              const summaryMatch = entry.match(/<summary>([\s\S]*?)<\/summary>/);
              paper.summary = summaryMatch ? summaryMatch[1].trim() : "";
              
              papers.push(paper);
            }
            
            return papers;
          }
          
          function updateHTML(papers) {
            const escapeHtml = (text) => {
              const map = {"&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#039;"};
              return String(text).replace(/[&<>"']/g, m => map[m]);
            };
            
            const paperCards = papers.map(paper => {
              const authorStr = paper.authors.join(", ") || "Unknown";
              return "        <article class=\"paper-card\">\n          <header class=\"paper-header\">\n            <h3 class=\"paper-title\">\n              <a href=\"https://arxiv.org/abs/" + escapeHtml(paper.id) + "\" target=\"_blank\" rel=\"noopener noreferrer\">\n                " + escapeHtml(paper.title) + "\n              </a>\n            </h3>\n            <div class=\"paper-meta\">\n              <span class=\"paper-authors\">By " + escapeHtml(authorStr) + "</span>\n              <span class=\"paper-date\">Published: <time datetime=\"" + paper.published + "\">" + paper.published + "</time></span>\n            </div>\n          </header>\n          \n          <section class=\"paper-body\">\n            <p class=\"paper-summary\">\n              " + escapeHtml(paper.summary) + "\n            </p>\n          </section>\n          \n          <footer class=\"paper-footer\">\n            <a href=\"https://arxiv.org/pdf/" + escapeHtml(paper.id) + ".pdf\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"arxiv-link\">\n              Download PDF →\n            </a>\n          </footer>\n        </article>";
            }).join("\n");
            
            const timestamp = new Date().toISOString();
            const dateStr = new Date(timestamp).toUTCString().replace(/GMT/, "UTC");
            
            let html = fs.readFileSync("arxiv.html", "utf8");
            
            html = html.replace(
              /<section id="arxiv-papers" class="papers-grid">[\s\S]*?<\/section>/,
              "<section id=\"arxiv-papers\" class=\"papers-grid\">\n" + paperCards + "\n    </section>"
            );
            
            html = html.replace(
              /Last updated: <time datetime="[^"]*">[^<]*<\/time>/,
              "Last updated: <time datetime=\"" + timestamp + "\">" + dateStr + "</time>"
            );
            
            fs.writeFileSync("arxiv.html", html);
            console.log("Successfully updated arxiv.html with " + papers.length + " papers");
          }
          
          fetchPapers()
            .then(papers => {
              console.log("Fetched " + papers.length + " papers");
              if (papers.length > 0) {
                updateHTML(papers);
                console.log("✓ Papers updated successfully");
                process.exit(0);
              } else {
                console.log("⚠ No papers fetched, skipping update");
                process.exit(0);
              }
            })
            .catch(err => {
              console.error("✗ Error:", err.message);
              console.log("⚠ Continuing with empty update...");
              process.exit(0);
            });
          NODEJS_EOF
          
          node update_papers.js
      
      - name: Commit and push changes
        run: |
          git config user.name "Copilot"
          git config user.email "223556219+Copilot@users.noreply.github.com"
          
          if git diff --quiet arxiv.html; then
            echo "✓ No changes to commit"
          else
            echo "Committing changes..."
            git add arxiv.html
            git commit -m "chore: update arxiv papers [$(date -u +'%Y-%m-%d %H:%M:%S UTC')]" \
              -m "Co-authored-by: Copilot <223556219+Copilot@users.noreply.github.com>"
            git push origin main
            echo "✓ Changes pushed successfully"
          fi
      
      - name: Report status
        if: always()
        run: |
          echo "=== Workflow Completion Report ==="
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "Status: ${{ job.status }}"
          echo "Workflow: Update arXiv Papers Dashboard"
          echo "Run: ${{ github.run_number }}"
          echo "===================================="
